---
title: "Predecir la supervivencia de los árboles" 
author: 
  - Juan de Dios Castillo Calleja
  - Carlos Diepa Santana
  - María José Zamorano Poblete
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE)
```

![](logo_UCO.png){width=10%}
![](facultad_de_ciencias.png){width=10%}
 
### Introducción

En [kaggle](kaggle.com), se nos ha proporcionado la información de un estudio de la supervivencia de tres especies del género *Acer*, en el cual se estudiaron diferentes factores que podían influir en su supervivencia. Aquí se nos proporcionaba la base de datos del experimento, la información que aportaron los autores, y el artículo que se publicó analizando estos datos, que contenía más información sobre lo que se hizo. Por esto, sabemos que los datos están compuestos por 19 columnas que incluyen:

+ **No:** Identificador de las semillas.
+ **Species** Especies utilizadas, capaces de vivir en el mismo entorno, pero con diferente tolerancia a la luz. Las especies son:
  - Acsa = *Acer saccharum*
  - Acru = *Acer rubrum*
  - Acne = *Acer negundo*
+ **Light:** Niveles de luz utilizados en el experimento. Los niveles son:
  - Low = 2% luz directa
  - High = 30% luz directa
+ **Microbe:** Microorganismos utilizados, se obtuvo un filtrado de estos y se aplicaron, obteniéndose cinco tratamientos, que fueron:
  - Control: papel de filtro esterilizado.
  - None: agua desionizada y papel de filtro.
  - Small: 20 µm filtrado en agua desionizada y papel de filtro.
  - Large: agua desionizada y 40-250 µm filtrado en papel de filtro.
  - Combined: Small + Large, es decir, el filtrado estaba tanto en agua desionizada como en papel de filtro.
+ **Adult:** Número de árboles adultos que se utilizaron para recoger el suelo donde plantaron las semillas.
+ **Bench:** Número de la maceta donde se cultivó cada semilla.
+ **Harvest:** En qué semana fue cosechada la plántula para medir los datos. Pueden ser **3**, **6** o **9 semanas**.
+ **Time:** Día del experimento en el que la planta se cosechó, murió o terminó el experimento.
+ **Event:** Para analizar la supervivencia de las plántulas. Cada una se caracterizó como:
  - 0 = utilizada en el experimento.
  - 1 = muerta.
+ **AMF:** Porcentaje de colonización por los microorganismos. Calculado son los datos *AMFcount/AMFintersections*. Se basa en el número de colonias contadas en las raíces, en 100 intersecciones.
+ **Phenolics:** Calculado como nmol de ácido gálico equivalentes por mg de peso seco. Concentración de fenoles en tanto por 1.
+ **NSC:** Calculado como porcentaje de peso seco compuesto por carbohidratos no estructurales.
+ **Lignin:** Porcentaje de masa seca que corresponde a la lignina.
+ **<span style="color:orange">AMF\_Imp:</span>** Valores de *AMF* imputados.
+ **<span style="color:orange">PHN\_Imp:</span>** Valores de *Phenolics* imputados.
+ **<span style="color:orange">NSC\_Imp:</span>** Valores de *NSC* imputados.
+ **<span style="color:orange">LIG\_Imp:</span>** Valores de *Lignin* imputados.  


Lo primero que hicimos fue visualizar los datos que habíamos obtenido. Para esto, creamos una variable donde leímos el archivo proporcionado, que tenía la extensión **".csv"**. A la variable la llamamos: **tree_survival**.

```{r Lectura de datos, echo=TRUE, include=FALSE}
tree_survival <- read.csv("Tree_Data.csv")
```

Posteriormente, tras haber obtenido la variable, analizamos la información de nuestro dataset. Para ello, averiguamos la dimensión y clase de nuestros datos. Tras conocer esto, vamos a ver la información relevante de los mismos.

La base de datos del experimento es un *`r class(tree_survival)`* y sus dimensiones son de **`r nrow(tree_survival)` filas** y **`r ncol(tree_survival)` columnas**. Al comparar estas dimensiones, vemos que tiene 2400 observaciones, mientras que en el artículo nos habla de 1920. Al ver que tenemos datos imputados, conocemos entonces que hay <span style="color:red">datos perdidos</span> en el dataframe, por lo que vamos a visualizar la información de cada columna.

```{r Analisis de las columnas, echo=TRUE}
summary(tree_survival)
```
A partir de aquí, vamos a obtener el dataframe que se utilizó en el experimento, es decir, el que más observaciones tiene (1920). En primer lugar, vamos a instalar los paquetes necesarios que utilizaremos posteriormente. Comenzamos instalando los paquetes.

<!--  
#```{r Instalación de paquetes, echo=TRUE, message=FALSE, warning=FALSE}
install.packages("dplyr")
install.packages("ggplot2")
install.packages("tidyverse")
install.packages("tseries")
install.packages("vegan")
``` 
Los paquetes en nuestro caso ya están instalados, por lo que los vamos a comentar-->

Cuando ya los tengo instalados, procedo a cargar los paquetes.

```{r Cargamos los paquetes, echo=TRUE, message=FALSE, warning=FALSE}
library("dplyr")
library("ggplot2")
library("tidyverse")
library("tseries")
library("vegan")
```

Para realizar las pruebas estadísticas, hemos utilizado paquetes nuevos que no se dieron en clase. Los hemos instalado porque nos permiten realizar otras pruebas estadísticas que nos son de utilidad con nuestros datos. Con el paquete **<span style="color:blue">vegan</span>** usamos, por ejemplo, la función **adonis2** para hacer **PERMANOVAS** y con el paquete **<span style="color:blue">tseries</span>** utilizamos la prueba de normalidad **Jarque-Bera**. Además utilizamos el paquete **<span style="color:blue">stats</span>**, (con funciones cómo **shapiro.test** y **wilcox.test**) que ya viene preinstalado y cargado en R.  


Tengo ya los paquetes que serán de utilidad, por lo que ahora obtengo mi dataframe procesado.

### Obtención del dataframe

Al visualizar la información de cada columna, vemos que hay variables en las que tenemos 1510 datos perdidos, de ahí que se hayan hecho los valores imputados. Analizando las columnas y la cantidad de valores perdidos, hemos eliminado los valores no imputados y hemos seleccionado las variables que serán de utilidad posteriormente. Las variables seleccionadas son las que menos valores perdidos tienen, para así filtrar nuestro dataframe y eliminar las observaciones que tienen datos perdidos. Para conseguir esto, hicimos varias pruebas, de las cuales indicaremos con la que obtuvimos el dataframe de 1920 observaciones.

```{r Obtención del dataframe, echo=FALSE}
datos <- tree_survival %>% 
  select(Species,Light,Microbe,Bench,Time,Event,AMF_Imp,PHN_Imp,NSC_Imp,LIG_Imp)

datos %>% summary()

#Vemos que el valor de datos perdidos más alto es de 480. Por lo que eliminamos las observaciones que poseen valores perdidos.

datos_pr <-  drop_na(datos)
```
Debemos de tener ya el dataframe sin datos perdidos, nuestro data frame actual tiene: **<span style="color:blue">`r nrow(datos_pr)` observaciones</span>** y **<span style="color:blue">`r ncol(datos_pr)` variables</span>**. Comprobamos si hay datos perdidos en el dataframe.

```{r Visualizar datos perdidos, echo=FALSE}
datos_pr %>% 
  is.na() %>% 
  summary()
```
Tras esto observamos que no poseemos datos perdidos en ninguna variable y, por tanto, tenemos nuestro <span style="color:green">dataframe definitivo</span>. Lo guardamos con una extension **.csv** para utilizarlo posteriormente, leyendo directamente este dataframe.

```{r Guardamos datos procesados, echo=FALSE}
write.csv(datos_pr, "tree_survival_pr")
```

Cuando ya hemos guardado el archivo, analizamos los datos del dataframe.

### Hipótesis 1

#### Hipótesis 1.1

Leyendo el artículo asociado a los datos, hemos obtenido varias hipótesis, las cuales, trataremos de comprobar estadísticamente. Estas hipótesis nos ayudarán a saber porque algunas de las plantas pueden llegar a sobrevivir en mayor proporción en condiciones de poca luz y que factores influyen en esto:   

+ **Hipótesis 1**: Existe una relación entre las concentraciones de **fenoles** y carbohidratos no estructurales (**NSC**) y la supervivencia de las plantas en sombra. 

+ **Hipótesis 2**: Los **AMF** producen en la planta un aumento en la concentración de **NSC** y los microorganismos patógenos un aumento en la concentración de fenoles.

Como en el caso de *Event*, los datos están como 0 y 1, modificamos esa columna para obtener como datos "Vivo" y "Muerto", en el caso de que sea necesario para una variable, también filtramos los datos para que sólo nos de las plantas crecidas en sombra, ya que sólo en estas condiciones los fenoles y NSCs suponen una supuesta ventaja en la supervivencia.

```{r Creo dataframe para la hipótesis 1, echo=FALSE}
hipo1 <- datos_pr %>% select(PHN_Imp,NSC_Imp, Event, Light) %>% 
  mutate(Event = if_else(Event == 1, "Dead", "Alive")) %>% # Cambio event para tenerlo más claro
  filter(Light == "Low")
head(hipo1)     
```

Para comprobar si hay diferencias en las concentraciones de fenoles en las plantas hacemos dos dataframe con los carbohidratos no estructurales de las plantas muertas y las vivas. Cómo vemos en las siguientes líneas de código hacemos dos dataset para realizar la prueba de **U-Mann-Whitney**, lo que realizamos fue coger los datos de los NSC con if else y sustituir los valores que no pertenzcan al grupo por NA y después eliminar los NA para obtener dos dataframes con diferentes dimensiones.

```{r Creo dataframe de individuos muertos}
DeadPHN <- hipo1 %>% transmute (Dead = if_else(Event == "Dead", PHN_Imp, NA)) %>% 
  drop_na()
glimpse(DeadPHN)
```
```{r Creo dataframe de individuos vivos}
AlivePHN <- hipo1 %>% transmute (Alive = if_else(Event == "Alive", PHN_Imp, NA)) %>% 
  drop_na()
glimpse(AlivePHN)
```

Sacamos algunos estadísticos para que facilite la observación en primera instancia de posibles diferencias existentes entre ambos grupos. Vemos que las plantas vivas, de media, tienen casi el doble de fenoles que las muertas, lo que nos da una pista de que nuestra hipótesis pueder cierta.

```{r Resumen de los datos según supervivencia, echo=FALSE}
hipo1 %>% group_by(Event) %>%
  summarize(Media = mean(PHN_Imp),
         Max = max(PHN_Imp),
         Min = min(PHN_Imp))
```

Antes de empezar tenemos que saber si las variables siguen una distribución normal, para ello realizmos el test de normalidad **Shapiro-Wilk** del paquete **stats**:
```{r Análisis de distribución de individuos muertos,echo=FALSE}
shapiro.test(DeadPHN$Dead)
```
```{r Análisis de distribución de individuos vivos,echo=FALSE}
shapiro.test(AlivePHN$Alive)
```

En el test ha salido un p-valor menor a 0,05 por lo que descartamos la hipótesis nula y aceptamos la alternativa, los datos no se distribuyen normalmente.

Comprobamos, visualmente, que las variables no son normales, representamos la distribución de los datos con un histograma:
```{r Representación gráfica de la distribución de fenoles, echo=FALSE, message=FALSE}
hipo1 %>% ggplot(aes(x = PHN_Imp, fill = Event )) +
  geom_histogram(color = "black") +
  labs(x="Concentración de fenoles", y = " ") +
  scale_x_continuous(
    breaks = seq(-0.5, 0.6, by = 0.10), # Aquí estamos poniendo cada cuanto se ponen las marcas en el eje x
    limits = c(-0.5, 0.6))+ #establecemos aquí los límites del eje x
  ggtitle("Distribución de fenoles") +  
  theme(plot.title = element_text(hjust = 0.5, size = 16), #Aquí ajustamos algunos parámetros del gráfico
        axis.title.x = element_text(hjust = 0.5),
        panel.border = element_rect(colour = "black", linewidth = 0.7, fill = NA)) 
```

Ninguno sigue una distribución normal, por lo que tenemos que hacer una prueba no paramétrica, en este caso, de U-Mann-Whitney para comparar los dos grupos.

Con la prueba de U-Mann-Whitney, comparamos estadísticamente la diferencia entre los fenoles de los vivos y los muertos, en condiciones de sombra y obtenemos de resultado que no hay diferencia significativa entre los fenoles de vivos y muertos (p < 0.05), por lo que hay diferencias significativas en la concentración de fenoles confirmando parcialmente nuestra hipótesis.

```{r Diferencias en la concentración de fenoles, echo=FALSE}
wilcox.test(x = DeadPHN$Dead, y = AlivePHN$Alive)
```

Se elabora la siguiente gráfica para comprobar que si se presentan diferencias visuales notables.

```{r Análisis visual de concentración de fenoles, echo=FALSE, message=FALSE}
hipo1 %>% ggplot(aes(y = PHN_Imp, x = Event, col = Event )) +
  geom_jitter(width = 0.2, show.legend = F, alpha = 0.6) +
  geom_boxplot(show.legend = F, width = 0.55) + 
  labs(x="Supervivencia", y="Concentración de fenoles") +
  theme(axis.title.x = element_text(hjust = 0.5), #Ajustamos algunos parámetros del gráfico para hacerlo más bonito
        panel.border = element_rect(colour = "black", linewidth = 0.7, fill = NA),
        panel.background = element_blank())
```

**Podemos ver diferencias notables, la concentración de fenoles es visualmente más grande en plantas vivas.**

#### Hipotesis 1.2

Ahora para comprobar si hay diferencias en las concentraciones de NSC en las plantas hacemos dos dataframe con los carbonos no estructurales de las plantas muertas y las vivas. Cómo vemos en las siguientes líneas de código hacemos dos dataset para realizar la prueba de **U-Mann-Whitney**, lo que realizamos fue coger los datos de los fenoles con **if_else** y sustituir los valores que no pertenzcan al grupo por NA y después eliminar los NA para obtener dos dataframes con diferentes dimensiones.

```{r Creo variable de individuos muertos}
DeadNSC <- hipo1 %>% transmute (Dead = if_else(Event == "Dead", NSC_Imp, NA)) %>% 
  drop_na() 
```
```{r Creo variable de individuos vivos}
AliveNSC <- hipo1 %>% transmute (Alive = if_else(Event == "Alive", NSC_Imp, NA)) %>% 
  drop_na()
```

Para que se aprecie más fácilmente las diferencias que puedan existir entre ambos grupos, se exponen los siguientes estadícos, vemos que las medias son algo parecidas, sin embargo, en plantas vivas el NSC es de media 0,5 más alto. Más tarde comprobaremos estadíticamente si hay diferencias entre los grupos.

```{r Resumen de datos según supervivencia_2, echo=FALSE}
hipo1 %>% group_by(Event) %>% #Agrupamos por Event
  summarize(Media = mean(NSC_Imp), #Ponemosmlos gráficos que queramos
            Max = max(NSC_Imp),
            Min = min(NSC_Imp))
```

Antes de empezar tenemos que saber si las variables siguen una distribución normal, para ello utilizamos el test de normalidad de **Shapiro-Wilk**:

```{r Análisis de distribución de individuos muertos_2,echo=FALSE}
shapiro.test(DeadNSC$Dead)
```
```{r Análisis de distribución de individuos vivos_2, echo=FALSE}
shapiro.test(AliveNSC$Alive)
```

En ambos test ha salido un p-valor inferior a 0,05 por lo que aceptamos la hipótesis alternativa, los datos no se distribuyen normalmente.

Comprobamos, visualmente, que las variables no son normales:
```{r Representación grafica de la concentración de carbohidratos, echo=FALSE, message=FALSE}
hipo1 %>% ggplot(aes(x = NSC_Imp, fill = Event)) +
  geom_histogram(color = "black") + 
  labs(x="Concentración de carbohidratos solubles", y = " ") +
  scale_x_continuous(
    breaks = seq(0, 20, by = 5), # Aquí estamos poniendo cada cuanto se ponen las marcas en el eje x
    limits = c(0,20)) +  #establecemos aquí los límites del eje x
  ggtitle("Distribución de NSCs") +  
  theme(plot.title = element_text(hjust = 0.5, size = 16),
        axis.title.x = element_text(hjust = 0.5), #Aquí ajustamos algunos parámetros del gráfico
        panel.border = element_rect(colour = "black", linewidth = 0.7, fill = NA)) 
```

Parece que pueden seguir una distribución normal según el gráfico, probamos con el test de normalidad **Jarque Bera**, así nos aseguraremos que los datos no siguen de ningún modo una distribución normal.

```{r Análisis de la distribución de los datos (Individuos muertos), echo=FALSE}
jarque.bera.test(DeadNSC$Dead)
```
```{r Análisis de la distribución de los datos (Individuos vivos), echo=FALSE}
jarque.bera.test(AliveNSC$Alive)
```

Sigue saliendo significativo el p-valor, por lo que consideramos una distribución no normal de los datos, de ahí que realicemos U-Mann-Whitney:

```{r Diferencias de la concentración de carbohidratos,echo=FALSE}
wilcox.test(x = DeadNSC$Dead, y = AliveNSC$Alive)
```
Los resultados demuestran que, estadísticamente, las plantas muertas y vivas tienen diferentes significativas en sus concentraciones de carbonos no estructurales (p < 0,05). Lo que respalda nuestra hipótesis.

Realizamos una representación gráfica para distinguir si hay una diferencia visual entre las plantas vivas y muertas. Vemos que los NSC en los vivos es mayor que en muertos, confirmando nuestra hipótesis.

```{r Representación gráfica de la concentración de carbohidratos según supervivencia,echo=FALSE, message=FALSE}
hipo1 %>% ggplot(aes(y = NSC_Imp, x = Event, col = Event )) +
  geom_jitter(width = 0.2, show.legend = F, alpha = 0.6) +
  labs(x="Supervivencia", y="Concentración de carbohidratos solubles")+
  geom_boxplot(show.legend = F, width = 0.55) + 
  theme(axis.title.x = element_text(hjust = 0.5),
        panel.border = element_rect(colour = "black", linewidth = 0.7, fill = NA),
        panel.background = element_blank())
```

#### Comparación de las hipótesis 1.1 y 1.2

Por último, realizamos un *Permutational analysis of variance* o *Permanova* (datos no paramétricos) para asegurarnos de que hay diferencias en la concentración de fenoles y NSC entre vivas y muertas en conjunto. Este análisis nos ayudará a saber si en conjunto hay diferencias entre las variables y los grupos.  

```{r Análisis no paramétrico para comparar las variables}
adonis2( hipo1[, c("PHN_Imp","NSC_Imp")] ~ Event, data = hipo1, method = "euclidean", permutations = 99) %>% 
  print()
```

El resultado del Permanova demuestra que se pueden diferenciar ambos grupos (p < 0.05) en cuanto las concentraciones de fenoles y NSC y cómo hemos visto las plantas vivas demuestran tener mayor cantidad de estos compuestos. Esto confirma nuestra hipótesis, los fenoles y NSC influyen positivamente a la supervivencia en sombra.

###Hipótesis 2

Para la segunda hipótesis planteada, se van a comprobar si los tratamientos con los microorganismos influyen positivamente en la concentración de fenoles y NSCs.

```{r Creación de variable para la hipotesis 2}
hipo2 <- datos_pr %>% select(PHN_Imp,NSC_Imp, Event, Microbe) %>% 
  mutate(Event = if_else(Event == 1, "Dead", "Alive")) %>% 
  filter(Event == "Alive")
```

Para verificar qué tan diferentes son los grupos, a primera vista, recurrimos a analizar los valores medios y a una representación gráfica.

#### Hipótesis 2.1

```{r Resumen de los datos}
hipo2 %>% group_by(Microbe) %>% # Comprobamos que tan diferentes son los grupos a primera vista
  summarize(Media = mean(PHN_Imp),
            Max = max(PHN_Imp),
            Min = min(PHN_Imp))
```
 
```{r Representación gráfica de la concentración de fenoles según tratamiento}
hipo2 %>% 
  ggplot(aes(y = PHN_Imp, x = Microbe, col = Microbe )) +
  geom_jitter(width = 0.2, show.legend = F, alpha = 0.6) +
  labs(x="Tratamiento con microorganismos", y="Concentración de fenoles")+
         geom_boxplot(show.legend = F, width = 0.55) + # Elimino la leyenda 
         theme(axis.title.x = element_text(hjust = 0.5),
               panel.border = element_rect(colour = "black", linewidth = 0.7, fill = NA),
               panel.background = element_blank()) 
```

Ejecutamos un *Permanova* (datos no paramétricos) para asegurarnos de que no hay diferencias en la concentración de fenoles y NSC, entre vivas y muertas. 

```{r Diferencias en la concentración de fenoles según tratamiento}
adonis2( hipo2$PHN_Imp ~ Microbe, data = hipo2, method = "euclidean"
         , permutations = 99) %>% print()
```

#### Hipótesis 2.2

```{r Resumen de los datos_2}
hipo2 %>% group_by(Microbe) %>% # Comprobamos que tan diferentes son los grupos a primera vista
  summarize(Media = mean(NSC_Imp),
            Max = max(NSC_Imp),
            Min = min(NSC_Imp))
```

```{r Representación gráfica de la concentración de carbohidratos según tratamiento}
hipo2 %>% ggplot(aes(y = NSC_Imp, x = Microbe, col = Microbe )) +
  geom_jitter(width = 0.2, show.legend = F, alpha = 0.6) +
  geom_boxplot(show.legend = F, width = 0.55) + # Elimino la leyenda 
  labs(y="Concentración de carbohidratos solubles", x="Tratamiento con microorganismos")+
  theme(axis.title.x = element_text(hjust = 0.5),
        panel.border = element_rect(colour = "black", linewidth = 0.7, fill = NA),
        panel.background = element_blank()) 
```

```{r Diferencias en la concentración de carbohidratos según tratamiento}
adonis2( hipo2$NSC_Imp ~ Microbe, data = hipo2, method = "euclidean", permutations = 99) %>% print()
```

#### Comparación de hipótesis 2.1 y 2.2.

```{r Análisis no paramétrico para comparar variables_2}
adonis2( hipo2[, c("PHN_Imp","NSC_Imp")] ~ Microbe, data = hipo2, method = "euclidean", permutations = 99) %>% print()
```

### Hipótesis 3

**Tercera hipótesis**: ¿Qué supone que las AMF compitan con los patógenos para conquistar las raíces?

Ahora filtramos los *large* y *small* para conocer si hay diferencias en fenoles y NSC...
```{r Filtramos tratamientos}
hipo2.1 <- datos_pr %>% select(PHN_Imp,NSC_Imp, Event, Microbe) %>% 
  mutate(Event = if_else(Event == 1, "Dead", "Alive")) %>% 
  filter(Event == "Alive")
```

```{r Creamos variable de tratamiento "small"}
smallPHN <- hipo2.1 %>% transmute (small = if_else(Microbe == "Small", PHN_Imp, NA)) %>% 
  drop_na()
```

```{r Creamos variable de tratamiento "large"}
largePHN <- hipo2.1 %>% transmute (large = if_else(Microbe == "Large", PHN_Imp, NA)) %>% 
  drop_na()
```

```{r}
wilcox.test(x = smallPHN$small, y = largePHN$large)
```

```{r}
smallNSC <- hipo2.1 %>% transmute (small = if_else(Microbe == "Small", NSC_Imp, NA)) %>% 
  drop_na()
```

```{r}
largeNSC <- hipo2.1 %>% transmute (large = if_else(Microbe == "Large", NSC_Imp, NA)) %>% 
  drop_na()
```

```{r}
wilcox.test(x = smallNSC$small, y = largeNSC$large)
```
